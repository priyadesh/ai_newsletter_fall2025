<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Article</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fallback-image-container {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); /* Light blue gradient */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fallback-image-container .fas {
            font-size: 6rem;
            color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <a href="/" class="text-white hover:text-blue-200 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Newsletter
                    </a>
                    <h1 class="text-2xl font-bold mt-2">AI News Article</h1>
                </div>
                <div class="text-sm">
                    <span id="articleId" class="bg-white bg-opacity-20 px-3 py-1 rounded-full"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading-spinner inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-gray-600">Loading article...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-4"></i>
            <h3 class="text-lg font-semibold text-red-800 mb-2">Article Not Found</h3>
            <p id="errorMessage" class="text-red-600 mb-4"></p>
            <a href="/" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                Back to Newsletter
            </a>
        </div>

        <!-- Article Content -->
        <article id="articleContent" class="hidden max-w-4xl mx-auto">
            <!-- Article Header -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div id="articleHeader">
                    <!-- Article header will be loaded here -->
                </div>
            </div>

            <!-- Article Body -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div id="articleBody">
                    <!-- Article body will be loaded here -->
                </div>
            </div>

            <!-- Article Actions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <a id="sourceLink" href="#" target="_blank"
                           class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                        </a>
                        <button id="shareBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-share mr-2"></i>Share
                        </button>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="relevanceScore"></span>
                    </div>
                </div>
            </div>
        </article>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Powered by AI • Generated with ❤️ for the AI community</p>
        </div>
    </footer>

    <script>
        class ArticleApp {
            constructor() {
                this.apiBase = '/api/v1';
                this.articleId = '{{ article_id }}';
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadArticle();
            }

            setupEventListeners() {
                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.shareArticle();
                });
            }

            async loadArticle() {
                this.showLoading();
                this.hideError();

                try {
                    const response = await fetch(`${this.apiBase}/newsletter/${this.articleId}`);
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail.message || 'Failed to load article');
                    }

                    if (result.success && result.data) {
                        this.renderArticle(result.data);
                        this.hideLoading();
                        this.showContent();
                    } else {
                        throw new Error('Invalid response format');
                    }

                } catch (error) {
                    console.error('Error loading article:', error);
                    this.showError(error.message);
                }
            }

            renderArticle(article) {
                this.renderHeader(article);
                this.renderBody(article);
                this.setupActions(article);
            }

            renderHeader(article) {
                const articleHeader = document.getElementById('articleHeader');
                const headerHTML = `
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1">
                            <h1 class="text-3xl font-bold text-gray-800 mb-4">${article.title}</h1>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span><i class="fas fa-newspaper mr-1"></i>${article.source}</span>
                                ${article.published_date ? `
                                    <span><i class="fas fa-calendar mr-1"></i>${new Date(article.published_date).toLocaleDateString()}</span>
                                ` : ''}
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">
                                    ${Math.round(article.relevance_score * 100)}% relevant
                                </span>
                            </div>
                        </div>
                    </div>
                    <div id="imageContainer" class="mb-6"></div>
                `;
                articleHeader.innerHTML = headerHTML;
                
                // Handle image rendering separately to properly handle fallback
                const imageContainer = document.getElementById('imageContainer');
                if (article.thumbnail) {
                    const img = document.createElement('img');
                    img.src = article.thumbnail;
                    img.alt = article.title;
                    img.className = 'w-full h-64 object-cover rounded-lg';
                    img.onerror = function() {
                        // Only show fallback if image fails to load
                        this.remove();
                        const fallback = document.createElement('div');
                        fallback.className = 'w-full h-64 fallback-image-container rounded-lg';
                        fallback.innerHTML = '<i class="fas fa-robot text-white text-6xl"></i>';
                        imageContainer.appendChild(fallback);
                    };
                    imageContainer.appendChild(img);
                } else {
                    // No thumbnail, show fallback
                    const fallback = document.createElement('div');
                    fallback.className = 'w-full h-64 fallback-image-container rounded-lg';
                    fallback.innerHTML = '<i class="fas fa-robot text-white text-6xl"></i>';
                    imageContainer.appendChild(fallback);
                }
            }

            renderBody(article) {
                const articleBody = document.getElementById('articleBody');
                articleBody.innerHTML = `
                    <div class="prose max-w-none">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Summary</h2>
                        <p class="text-gray-700 text-lg leading-relaxed mb-8">${article.summary}</p>

                        ${article.key_points && article.key_points.length > 0 ? `
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Key Points</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                ${article.key_points.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }

            setupActions(article) {
                const sourceLink = document.getElementById('sourceLink');
                sourceLink.href = article.url;
                document.getElementById('relevanceScore').textContent =
                    `Relevance: ${Math.round(article.relevance_score * 100)}%`;
            }

            shareArticle() {
                if (navigator.share) {
                    navigator.share({
                        title: document.title,
                        text: 'Check out this AI news article',
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        alert('Article link copied to clipboard!');
                    });
                }
            }

            showLoading() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('articleContent').classList.add('hidden');
            }

            hideLoading() {
                document.getElementById('loadingState').classList.add('hidden');
            }

            showContent() {
                document.getElementById('articleContent').classList.remove('hidden');
            }

            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('loadingState').classList.add('hidden');
            }

            hideError() {
                document.getElementById('errorState').classList.add('hidden');
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ArticleApp();
        });
    </script>
</body>
</html>
